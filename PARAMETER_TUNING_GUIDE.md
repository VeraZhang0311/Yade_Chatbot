# API参数调优指南

如果修改提示词后，回复长度还是不理想，可以通过调整API参数来优化。

## 参数位置

打开 `yade_chatbot.py`，找到第380-386行左右的参数配置：

```python
"parameters": {
    "temperature": 0.7,    # 当前值
    "top_p": 0.8,         # 当前值
    "max_tokens": 1500    # 当前值
}
```

## 参数说明与建议值

### 1. temperature（创造性/随机性）

**作用**: 控制回复的创造性和随机性
- 值越高 → 回复越多样、越长、越"发散"
- 值越低 → 回复越保守、越短、越"收敛"

**建议调整**:

| 当前问题 | 推荐值 | 说明 |
|---------|--------|------|
| 回复太长、太啰嗦 | `0.5` | 让AI更保守，减少发挥 |
| 回复太短、太生硬 | `0.8` | 增加一些灵活性 |
| 当前(平衡) | `0.7` | 默认值，适中 |

**示例修改**:
```python
"temperature": 0.5,  # 从0.7降到0.5，让回复更简短
```

---

### 2. top_p（多样性/核采样）

**作用**: 控制词汇选择的多样性
- 值越高 → 考虑更多可能的词，回复更多样
- 值越低 → 只选择最可能的词，回复更直接

**建议调整**:

| 当前问题 | 推荐值 | 说明 |
|---------|--------|------|
| 回复太长、太啰嗦 | `0.7` | 限制词汇选择，更直接 |
| 回复太死板 | `0.9` | 增加表达多样性 |
| 当前(平衡) | `0.8` | 默认值，适中 |

**示例修改**:
```python
"top_p": 0.7,  # 从0.8降到0.7，让回复更直接
```

---

### 3. max_tokens（最大长度限制）

**作用**: 强制限制生成的最大token数
- 1个中文字约等于1.5-2 tokens
- 1句话约30-60 tokens

**建议调整**:

| 回复预期长度 | 推荐值 | 约等于字数 |
|------------|--------|-----------|
| 1-2句话 | `100` | 50-70字 |
| 2-3句话 | `200` | 100-130字 |
| 3-5句话 | `400` | 200-260字 |
| 当前(较长) | `1500` | 750-1000字 |

**示例修改**:
```python
"max_tokens": 300,  # 从1500降到300，强制限制长度
```

---

## 推荐配置组合

### 配置A: 极简模式（最短回复）

```python
"parameters": {
    "temperature": 0.4,   # 非常保守
    "top_p": 0.6,        # 限制词汇
    "max_tokens": 150    # 强制短回复
}
```

**适用场景**: 亚德几乎不说话，只回应必要信息

---

### 配置B: 简短模式（推荐）⭐

```python
"parameters": {
    "temperature": 0.5,   # 较保守
    "top_p": 0.7,        # 较直接
    "max_tokens": 300    # 2-4句话
}
```

**适用场景**: 保持简短但不失温度，推荐配置

---

### 配置C: 平衡模式（当前）

```python
"parameters": {
    "temperature": 0.7,   # 适中
    "top_p": 0.8,        # 适中
    "max_tokens": 1500   # 较长
}
```

**适用场景**: 允许较长回复，适合深入对话

---

### 配置D: 灵活模式

```python
"parameters": {
    "temperature": 0.8,   # 较灵活
    "top_p": 0.9,        # 多样性高
    "max_tokens": 500    # 中等长度
}
```

**适用场景**: 保持简短但允许更多创造性表达

---

## 实际操作步骤

### 步骤1: 定位代码

打开 `yade_chatbot.py`，搜索 `"parameters"`，找到这一段：

```python
payload = {
    "model": self.model,
    "input": {
        "messages": messages
    },
    "parameters": {
        "temperature": 0.7,  # ← 这里修改
        "top_p": 0.8,        # ← 这里修改
        "max_tokens": 1500   # ← 这里修改
    }
}
```

### 步骤2: 修改参数

根据你的需求，选择上面的配置组合之一，替换这三个值。

### 步骤3: 测试效果

```bash
python yade_chatbot.py
```

测试输入:
```
你好
今天心情不太好
我和家人吵架了
```

观察回复长度是否符合预期。

### 步骤4: 微调

如果还是不满意，继续微调：
- 还是太长 → 降低temperature和max_tokens
- 太短了 → 提高temperature
- 太死板 → 提高top_p

---

## 常见问题

**Q: 为什么改了参数还是很长？**

A: 因为系统提示词对长度的影响更大。建议：
1. 先确保系统提示词已经更新（查看开头是否有⚠️标记）
2. 再调整参数进行微调

**Q: temperature设置多少最好？**

A: 
- 对于"沉默寡言"的角色，建议 `0.4-0.6`
- 对于"温和但话不多"的角色，建议 `0.5-0.7`
- 默认 `0.7` 可能偏高

**Q: max_tokens是硬限制吗？**

A: 是的，AI生成到这个token数就会被强制截断。但这只是上限，实际回复可能更短。

**Q: 如何知道1500 tokens大约多少字？**

A: 粗略估算：
- 英文: 1 token ≈ 0.75 个单词
- 中文: 1 token ≈ 0.5-0.7 个字
- 1500 tokens ≈ 750-1000 中文字 ≈ 25-35句话

**Q: 参数会影响角色性格吗？**

A: 不会。性格由系统提示词决定，参数只影响：
- 回复长度
- 表达多样性
- 创造性

---

## 对比测试

### 修改前（temperature=0.7, max_tokens=1500）

```
你: 你好
亚德: 你好。我是亚德，一个来自涅夫海湾的旅行者。很高兴见到你，如果你有什么想聊的，我会在这里倾听。风雪漫长，有个伴总是好的。
```

### 修改后（temperature=0.5, max_tokens=300）

```
你: 你好
亚德: 你好。我是亚德。
```

---

## 推荐的完整配置

**对于"沉默寡言"的亚德，推荐使用配置B（简短模式）**:

```python
"parameters": {
    "temperature": 0.5,
    "top_p": 0.7,
    "max_tokens": 300
}
```

这个配置在保持角色性格的同时，给予足够的表达空间，不会让回复过于生硬。

---

**记住**: 参数调优是辅助手段，系统提示词才是关键！
